<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link data-n-head="1" rel="icon" type="image/x-icon" href="./static/favicon.ico">
        <title>Cash App Game Client</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100;200;300;400;500;700;900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
    <div id="screenspace" class="cashapp">
        <div id="loading">
            <img src="./static/Spinner4.gif" id="spinner">
        </div>
        <div id="boxGame">
            <div id="timerHolder">
                <p id="timerText" class="cashapp">_ACT_FAST</p>
                <p id="timer" class="cashapp">:30</p>
            </div>
            <div id='gridHolder'>
                <div id="grid">
                    <div id='box1' class="box flip-card">
                        <div id='box-inner1' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent1' class="boxPercent">0%</p>
                                <p id='boxText1'>1</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue1">$100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box2' class="box flip-card">
                        <div id='box-inner2' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent2' class="boxPercent">0%</p>
                                <p id='boxText2'>2</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue2">$200</p>
                            </div>
                        </div>
                    </div>
                    <div id='box3' class="box flip-card">
                        <div id='box-inner3' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent3' class="boxPercent">0%</p>
                                <p id='boxText3'>3</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue3">$300</p>
                            </div>
                        </div>
                    </div>
                    <div id='box4' class="box flip-card">
                        <div id='box-inner4' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent4' class="boxPercent">0%</p>
                                <p id='boxText4'>4</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue4">$400</p>
                            </div>
                        </div>
                    </div>
                    <div id='box5' class="box flip-card">
                        <div id='box-inner5' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent5' class="boxPercent">0%</p>
                                <p id='boxText5'>5</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue5">$500</p>
                            </div>
                        </div>
                    </div>
                    <div id='box6' class="box flip-card">
                        <div id='box-inner6' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent6' class="boxPercent">0%</p>
                                <p id='boxText6'>6</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue6">$600</p>
                            </div>
                        </div>
                    </div>
                    <div id='box7' class="box flip-card">
                        <div id='box-inner7' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent7' class="boxPercent">0%</p>
                                <p id='boxText7'>7</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue7">$700</p>
                            </div>
                        </div>
                    </div>
                    <div id='box8' class="box flip-card">
                        <div id='box-inner8' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent8' class="boxPercent">0%</p>
                                <p id='boxText8'>8</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue8">$800</p>
                            </div>
                        </div>
                    </div>
                    <div id='box9' class="box flip-card">
                        <div id='box-inner9' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxPercent9' class="boxPercent">0%</p>
                                <p id='boxText9'>9</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue9">$900</p>
                            </div>
                        </div>
                    </div>
                    <div id='box10' class="box flip-card">
                        <div id='box-inner10' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText10'>.</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue10">$1000</p>
                            </div>
                        </div>
                    </div>
                    <div id='box0' class="box flip-card">
                        <div id='box-inner0' class="flip-inner cashapp">
                            <div class="flip-front">
                                
                                <p id='boxPercent0' class="boxPercent">0%</p>
                                <p id='boxText0'>0</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue0">$1100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box12' class="box flip-card">
                        <div id='box-inner12' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText12'> < </p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue12">$1200</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chatGame">
            <div id="royaleHolder" class="cashapp">
                <div id="wordHolder">
                </div>
            </div>
            <div id="eliminationHolder">
                <h1>Eliminations Leader</h1>
                <h1 id="eliminations"></h1>
            </div>
            <div id="uiHolder">
                <div>
                    <p>OnSreen:<span  id="onscreen">0</span></p>
                </div>
                <div>
                    <p>OffScreen:<span id="offscreen">0</span></p>
                </div>
                <div>
                    <p>Total:<span id="total">0</span></p>
                </div>
            </div>
        </div>
        <div id="startScene">
            <div id="startText">
                <h1 id="startHeader">Cash App</h1>
                <img src="./static/royaletext.png" class='startImage'>
                <!-- <h1>CASH APP ROYALE</h1> -->
                <h1 id='startMidText'>WILL BEGIN IN</h1>
                <h1 id="startCountdown">~</h1>
                <div class="decor1"></div>
                <div class="decor2"></div>
                <div class="decor3"></div>
            </div>
        </div>
        <div id="intermissionScene">
            <div id="intermissionText">
                <h1 id="intermissionHeader">Cash App</h1>
                <img src="./static/royaletext.png" class='startImage'>
                <h1 id="intermissionMidText">WILL BEGIN IN</h1>
                <h1 id="royaleCountdown">~</h1>
                <div class="decor1"></div>
                <div class="decor2"></div>
                <div class="decor3"></div>
            </div>
        </div>
        <div id="newRoundScene">
            <div id="newRoundText">
                <h1 id="winnerName">skattefri</h1>
                <h1 id="newRoundText3">JUST WON</h1>
                <h1 id="prize">$100</h1>
                <h1 id="newRoundText2">NEXT ROUND<br/>BEGINS IN:</h1>
                <h1 id="roundCountdown">~</h1>
            </div>
            <div class="decor4"></div>
            <div class="decor5"></div>
            <div class="decor6"></div>
            <div class="decor7"></div>
        </div>
        <div id="textHolder">
            <div id="prizeHolder">
                <h1>Prize Pool: <span id="prizeAmount">0</span></h1>
                <h1>Prizes Earned: <span id="prizeEarned">0</span></h1>
                <h1 id="min">Min: </h1>
                <h1 id="max">Max: </h1>
                <h1 id="avg">Avg: </h1>
            </div>
            <div id="roundHolder">
                <h1 id="currentRound">Round: 1</h1>
            </div>
            <div id="winnerHolder">
            </div>
        </div>
    </div>
    <!-- <script src="main.js"></script> -->
    <script src="tmi.min.js"></script>
	<script src="helper.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script
  src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"
  integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY="
  crossorigin="anonymous"></script>
    <script>
        /* Twitch chatbot script */
        const commandArray = ['up', 'down', 'left', 'right'];
        const client = new tmi.Client(opts);
        let tmiConnected = false
        var mainAudio = new Audio("./static/soundFX/main.wav")
        mainAudio.loop = true
        var minAudio = new Audio("./static/soundFX/small_value_prize.wav")
        var medAudio = new Audio("./static/soundFX/medium_value_prize.wav")
        var maxAudio = new Audio("./static/soundFX/high_value_prize.wav")
        var prizeAudio = [minAudio, medAudio, maxAudio]
        var winnerAudio1 = new Audio("./static/soundFX/win_1.wav")
        var winnerAudio2 = new Audio("./static/soundFX/win_2.wav")
        var winnerAudio3 = new Audio("./static/soundFX/win_3.wav")
        var winnerAudio4 = new Audio("./static/soundFX/win_4.wav")
        var winnerAudio5 = new Audio("./static/soundFX/win_5.wav")
        var winnerAudios = [
            winnerAudio1,
            winnerAudio2,
            winnerAudio3,
            winnerAudio4,
            winnerAudio5
        ]
        var countdownAudio = new Audio("./static/soundFX/in_between_last_number.wav")
        var tickAudio = new Audio("./static/soundFX/in_between_counter_numbers.wav")
        var eliminateAudio = new Audio("./static/soundFX/eliminate_player.wav")
        client.on('message', onMessageHandler);
        client.on('connected', onConnectedHandler);
        client.on('disconnected', onDisonnectedHandler);
        // client.connect();
        function onMessageHandler (target, context, msg, self) {
            let message = msg.trim();
            console.log(message)
            if(!(settings.chatGame)){
                if(message.length == 1){
                    let parsed = parseInt(message)
                    votes[parsed] += 1
                }
                
            }else{
                let wordNumber = message.split(' ').length
                if(wordNumber == 1){
                    message = message.LowerCase()
                    if(renderList.hasOwnProperty(message)){
                        removeWord(message)
                        if(eliminations.hasOwnProperty(context['display-name'])){
                            eliminations[context['display-name']] = eliminations[context['display-name']] + 1
                        }else{
                            eliminations[context['display-name']] = 1
                        }
                        leader = Object.entries(eliminations).sort(([,a],[,b]) => b-a).slice(0,1)[0]
                        document.getElementById("eliminations").innerText = leader[0] + " - " + leader[1]
                    }
                }
            }
        }
        function onConnectedHandler (addr, port) {
            console.log(`* Connected to ${addr}:${port}`);
            tmiConnected = true
        }
        function onDisonnectedHandler () {
            console.log(`* Disconnected from twitch TMI`);
            tmiConnected = false
        }
        
        let domEntered = false
        document.addEventListener("click", ()=>{
            if(!domEntered){
                startAudio()
                domEntered = true
            }
        });
        let selected = 5;
        let currentCountdown = 10;
        let currentRound = 0;
        let earnedPrizes = 0;
        let currentPrize = 0;
        let override = [];
        let winners = [];
        let shuffleList = {}
        var voteCount = 0;
        let ws = new WebSocket("wss://lhek8s2pxc.execute-api.us-east-2.amazonaws.com/dev?app=game");
        var settings = {
            chatGame: false,
            chaos:false,
            interval:5,
            timer:30,
            on: true,
            activeThreshold: 1,
            maxPlayers: 1000,
            refill: 280,
            expectedRounds: 30,
            prizePool: 5000,
            countdown: 5
        }
        let votes = [0,0,0,0,0,0,0,0,0,0]
        let demoMode = false
        var audioLevels = {

        }
        /* Gridgame script */
        async function countDown(element){
            currentCountdown = settings.countdown
            for(currentCountdown; currentCountdown > 0; currentCountdown--){
                element.innerText = currentCountdown
                tickAudio.play()
                await sleep(980)
            }
            countdownAudio.play()
            return;
        }
        function loading(){
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'block'
        }
        function setIntermission(){
            document.getElementById('royaleCountdown').innerText = settings.countdown
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'none'
            document.getElementById('intermissionScene').style.display = 'block'
        }
        function setNewRoundScene(winner, amount){
            document.getElementById('winnerName').innerText = winner
            document.getElementById('prize').innerText = '$' + amount
            document.getElementById('startScene').style.display = 'none'
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'none'
            document.getElementById('newRoundScene').style.display = 'block'
        }
        function setScene(check){
            console.log("Setting Scene: ", check)
            if(check){
                document.getElementById('startScene').style.display = 'none'
                document.getElementById('chatGame').style.display = 'block'
                document.getElementById('boxGame').style.display = 'none'
                document.getElementById('loading').style.display = 'none'
                document.getElementById('intermissionScene').style.display = 'none'
                document.getElementById('newRoundScene').style.display = 'none'
            }else{
                document.getElementById('startScene').style.display = 'none'
                document.getElementById('chatGame').style.display = 'none'
                document.getElementById('boxGame').style.display = 'block'
                document.getElementById('loading').style.display = 'none'
                document.getElementById('intermissionScene').style.display = 'none'
                document.getElementById('newRoundScene').style.display = 'none'
            }
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        function shuffle(arr) {
            var i = arr.length, j, temp;
            while(--i > 0){
                j = Math.floor(Math.random()*(i+1));
                temp = arr[j];
                arr[j] = arr[i];
                arr[i] = temp;
            }
        }
        function runVote(){
            
        }
        function reveal(){
            for(let i = 0; i < 10; i++){
                let target = 'box' + i;
                let ele = document.getElementById(target)
                ele.classList.add('show-card')
            }
        }
        const average = (array) => array.reduce((a, b) => a + b) / array.length;
        let globalmin;
        let globalmax;
        function setup(){
            let prizes = []
            if(override.length == 0){
                let max = Math.floor((settings.prizePool-earnedPrizes)/(settings.expectedRounds-currentRound)/5)*5;
                let min = Math.floor((0.2 + currentRound * (0.30/settings.expectedRounds))*max/5)*5
                globalmax = max
                globalmin = min
                prizes = [max,min,min,min]
                for(let i = 0; i<6; i++){
                    prizes.push(Math.floor(getRandomIntInclusive(min+5,max-5)/5)*5)
                }
                console.log("prizes:", prizes)
                document.getElementById('min').innerText = 'Min: ' + min
                document.getElementById('max').innerText = 'Max: ' + max
                document.getElementById('avg').innerText = 'Avg: ' + average(prizes)
                shuffle(prizes)
                console.log("Suffled prizes:", prizes)
            }else{
                prizes = override;
            }
            for(let i = 0; i < 10; i++){
                let target = 'boxValue' + i;
                let ele = document.getElementById(target)
                ele.innerText = '$' + prizes[i]
            }
        }
        async function simulateRoyale(){
            while(total > 1){
                let keys = Object.keys(renderList)
                let rand = getRandomIntInclusive(0,keys.length-1)
                removeWord(renderList[keys[rand]])
                await sleep(50)
            }
        }
        async function reset(){
           
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        function voteAnimation(){
            let maxVote = Math.max(...votes)
            console.log("MAX VOTES:" + maxVote)
            const colorArray = ['#e93e3a','#ed683c','#ed683c','#f3903f','#f3903f','#fdc70c','#fdc70c','#fff33b','#fff33b','#000000']
            let sortedVotes = [...votes].sort(function(a, b){return b - a})
            console.log(votes)
            console.log(sortedVotes)
            for(let i = 0; i<10; i++){
                let current = votes[i]
                let colorhex = colorArray[sortedVotes.indexOf(current)]
                console.log("box " + i + ':' + colorhex)
                let target = '#box-inner' + i
                $(target).animate({backgroundColor: colorhex, }, {duration:700, queue:false})
            }
            console.log("VOTE ANIMATION DONE")
        }
        async function voteAnimation2(){
            let current = []
            let end = []
            let step = []
            // let maxVote = Math.max(...votes)
            let maxVote = votes.reduce(
                (previousValue, currentValue) => previousValue + currentValue,
                0
            );
                        for(let i  = 0;  i<10; i++){
                let target = 'boxPercent' + i
                let temp = document.getElementById(target)
                current[i] = parseInt(temp.innerText)
                end[i] = Math.round(votes[i]/maxVote*100)
                if (isNaN(end[i])) {
                    end[i] = 0
                }
                difference = end[i] - current[i]
                step[i] = difference/20
            }
            console.log(current)
            console.log(end)
            console.log(step)
            for(let j = 0; j<20;  j++){
                for(let i  = 0;  i<10; i++){
                    let target2 = 'boxPercent' + i
                    current[i] += step[i]
                    document.getElementById(target2).innerText = Math.round(current[i]) + '%'
                }
                await sleep(40)
            }
            
        }
        function checkWinner(){
            console.log("votes:", votes)
            let value = Math.max(...votes)
            console.log("value:", value)
            let pos = votes.indexOf(value)
            return pos
        }
        async function startRound(){
            currentPrize = 0
            currentRound++
            document.getElementById('currentRound').innerText = 'Round: ' + currentRound + '/' + settings.expectedRounds
            client.connect();
            voteCount = 0;
            let target = document.getElementById('timer')
            // let start = new Date().getTime();
            for(let j = settings.timer; j>=0; j--){
                // console.log(new Date().getTime() - start)
                console.log("COUNTER:",j)
                target.innerText = ':' + j
                if((j!=settings.timer) && (j%settings.interval == 0)){
                    if(demoMode){
                        for(let k = 0; k<10; k++){
                            votes[k] += getRandomIntInclusive(1,100)
                        }
                    }
                    console.log(votes)
                    voteAnimation2()
                }
                await sleep(970);

            }
            selected = checkWinner()
            console.log("SELECTED:", selected)
            document.getElementById('box' + selected).classList.add('show-card')
            let box = 'boxValue' + selected
            let winning = document.getElementById(box).innerText
            winning = winning.substring(1)
            if(winning == globalmin){
                minAudio.play()
            }else if(winning == globalmax){
                maxAudio.play()
            }else{
                medAudio.play()
            }
            for(let i = 15; i>=0; i--){
                target.style.visibility = (target.style.visibility == 'hidden' ? '' : 'hidden');
                await sleep(200);
            }
            reveal()
            client.disconnect();
            winning = parseInt(winning)
            earnedPrizes += winning
            currentPrize = winning
            document.getElementById("prizeEarned").innerText = '$' + earnedPrizes
            await sleep(4000); 
            setIntermission()
            let target2 = document.getElementById('royaleCountdown')
            await countDown(target2)
            ws.send(JSON.stringify({ action: 'message', header: 'startRoyale' }));
            await reset()
            settings.chatGame = true
            setScene(settings.chatGame)
        }
        /* Chat game script */
        let onscreen, offscreen, total;
        let myInterval;
        let leader;
        // shuffle(words)
        let words = []
        let renderList = {}
        let eliminations = {}
        console.log("JS LOADED")
        let startShuffle
        function startRoyale(players){
            document.getElementById("eliminations").innerText = ""
            words = []
            renderList = {}
            shuffleList = {}
            eliminations = {}
            console.log("Start Royale")
            shuffle(players)
            let playnum = Math.min(players.length, settings.maxPlayers)
            for(let i = 0; i<playnum; i++){
                words.push(players[i].twitchname.toLowerCase())
            }
            while(Object.keys(renderList).length< 600 && words.length){
                let item = words.pop()
                renderList[item]=item;
            }
            onscreen = Object.keys(renderList).length
            offscreen = words.length
            startShuffle = false
            display()
            client.connect();
            // console.log(words)
        }
        function shuffle(arr){
            let length = arr.length, rand, temp
            while(--length>0){
                rand = Math.floor(Math.random() * (length+1));
                temp = arr[rand];
                arr[rand] = arr[length];
                arr[length] = temp;
            }
        }
        var intervalID
        // loadRender()
        function display(){
            console.log("display")
            total = onscreen+offscreen
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            document.getElementById("offscreen").innerText = offscreen;
            document.getElementById("wordHolder").remove();
            let holder = document.createElement("div")
            holder.setAttribute("id", "wordHolder")
            document.getElementById("royaleHolder").append(holder)
            let i = 0;
            for(let item in renderList){
                // console.log(item)
                let div = document.createElement("div")
                div.setAttribute("class","word")
                // let name = "item"+i
                div.setAttribute("id",item.toLocaleLowerCase())
                let p = document.createElement("p")
                p.setAttribute("class","wordText")
                p.innerText = item
                div.append(p)
                document.getElementById("wordHolder").append(div)
                console.log(item)
                if(!startShuffle){
                    shuffleList[item]=item
                    setTimeout(() => {shuffleList[item] = item; console.log(item)}, 1000);
                }
                i++
            }
            if(!startShuffle && (offscreen >1)){
                intervalID = setInterval(shuffleInterval, 1100);
            }
            startShuffle = true
            

        }
        function nameExpand(check){
            if(check == 500){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow1")
                }
            }else if(check == 416){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow2")
                }
            }else if(check == 315){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow3")
                }
            }else if(check == 234){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow4")
                }
            }else if(check == 175){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow5")
                }
            }else if(check == 112){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow6")
                }
            }else if(check == 54){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow7")
                }
            }else if(check == 26){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow8")
                }
            }else if(check == 8){
                display()
                const collection = document.getElementsByClassName("word");
                for(let item of collection){
                    item.classList.add("grow9")
                }
            }
        }
        function shuffleInterval(){
            console.log("shuffleInterval")
            for(let item in shuffleList){
                if(renderList[item] === undefined){
                    delete shuffleList[item]
                }else{
                    if(getRandomIntInclusive(1,10) == 10){
                        removeWord(item)
                        delete shuffleList[item]
                        words.push(item)
                        offscreen++
                        total++
                        document.getElementById("offscreen").innerText = offscreen;
                        document.getElementById("total").innerText = total;
                        
                    }
                }
                
            }
        }
        function showEliminations(){
            console.log(eliminations)
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        async function removeWord(name){
            console.log("remove word:", name)
            let eliminateAudio2 = new Audio("./static/soundFX/eliminate_player.wav")
            eliminateAudio2.volume = audioLevels['eliminate']
            eliminateAudio2.play()
            delete renderList[name]
            total--
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            if(Object.keys(words).length){
                let item = words.pop()
                renderList[item] = item
                shuffleList[item] = item
                document.getElementById(name).children[0].innerText = item
                document.getElementById(name).id = item
                offscreen--
                document.getElementById("offscreen").innerText = offscreen;
            }else{
                document.getElementById(name).style.visibility = 'hidden'
                onscreen--
                document.getElementById("onscreen").innerText = onscreen;
            }
            if(onscreen == 599){
                console.log('clear interval!!!!!!!!!!!!!!!!!')
                clearInterval(intervalID)
            }
            if(onscreen == 500){
                nameExpand(500)
            }
            else if(onscreen == 416){
                nameExpand(416)
            }
            else if(onscreen == 315){
                nameExpand(315)
            }
            else if(onscreen == 234){
                nameExpand(234)
            }
            else if(onscreen == 175){
                nameExpand(175)
            }
            else if(onscreen == 112){
                nameExpand(112)
            }
            else if(onscreen == 54){
                nameExpand(54)
            }
            else if(onscreen == 26){
                nameExpand(26)
            }
            else if(onscreen == 8){
                nameExpand(8)
            }
            else if(onscreen<2){
                winnerAudios[getRandomIntInclusive(0,4)].play()
                client.disconnect();
                console.log("Winner: " + renderList[Object.keys(renderList)[0]])
                let newItem = {
                    name: renderList[Object.keys(renderList)[0]],
                    round: currentRound,
                    amount: currentPrize
                }
                winners.push(newItem)
                let para = document.createElement("p");
                para.innerText = newItem.name + ' has won: $' +   newItem.amount
                document.getElementById("winnerHolder").appendChild(para)
                setNewRoundScene(newItem.name, newItem.amount)
                if(currentRound < settings.expectedRounds){
                    votes = [0,0,0,0,0,0,0,0,0,0]
                    voteAnimation2()
                    let collection = document.getElementsByClassName("show-card");
                    let col2 = [...collection]
                    for(let item of col2){
                        item.classList.remove("show-card")
                    }
                    let target = document.getElementById("roundCountdown")
                    await countDown(target)
                    settings.chatGame = false
                    setScene(settings.chatGame)
                    startRound()
                }
            }
        }
        // display()
        function runGame(){
            myInterval = setInterval(randRemove, 50);
        }
        function newGameData(data){
            console.log('Game Data Received')
            currentRound = 0;
            earnedPrizes = 0;
            for(let item of data){
                currentRound++
                console.log(item)
                winners.push(item)
                earnedPrizes += item.amount
            }
            setup()
            document.getElementById('currentRound').innerText = 'Round: ' + currentRound + '/' + settings.expectedRounds
            document.getElementById('prizeEarned').innerText = '$' + earnedPrizes
        }
        function startAudio(){
            mainAudio.play()
        }
        function pauseAudio(){
            mainAudio.pause()
        }
        function audioControl(data){
            console.log("AUDIO DATA")
            console.log(data)
            mainAudio.volume = parseFloat(data.mainBG) * 0.01
            for(let sound of prizeAudio){
                sound.volume = parseFloat(data.prize) * 0.01
            }
            for(let sound of winnerAudios){
                sound.volume = parseFloat(data.winner) * 0.01
            }
            eliminateAudio.volume = parseFloat(data.elimination) * 0.01
            audioLevels['eliminate'] = parseFloat(data.elimination) * 0.01
            tickAudio.volume = parseFloat(data.countdown) * 0.01
            countdownAudio.volume = parseFloat(data.countdownEnd) * 0.01
        }
        /* Websocket script */
        let myCatInterval;
        let cattoggle= false
        function pingServer(){
            console.log("pinging server")
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
        }
        ws.onopen = function() {
            console.log('Websocket connected')
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
            ws.send(JSON.stringify({ action: 'message', header: 'getGameData' }));
            ws.send(JSON.stringify({ action: 'message', header: 'getAudio' }));
        }
        ws.onmessage = async function (evt) { 
            var received = evt.data;
            let parsed = JSON.parse(received)
            console.log(parsed)
            if(parsed.header == 'startGrid'){
                document.getElementById('startMidText').innerHTML = 'WILL BEGIN IN'
                let target = document.getElementById('startCountdown')
                await countDown(target)
                setScene(settings.chatGame)
                startRound();
            }else if(parsed.header == 'startRoyale'){
                startRoyale(parsed.data);
            }else if(parsed.header == 'resetGrid'){
                reset();
            }else if(parsed.header == 'newGameData'){
                newGameData(parsed.data);
            }else if(parsed.header == 'gameSettings'){
                let data = parsed.data
                console.log(data)
                settings.chatGame = data.chatScene
                settings.timer = data.gridDuration
                settings.interval = data.gridInterval
                settings.chaos = data.chaosMode
                settings.maxPlayers = data.maxPlayers
                settings.refill = data.refill
                settings.expectedRounds = data.expectedRounds
                settings.prizePool = data.prizePool
                settings.countdown = data.countdown
                currentCountdown = data.countdown
                document.getElementById("prizeAmount").innerText = '$' + data.prizePool
                reset()
                document.getElementById('loading').style.display = 'none'
                document.getElementById('startScene').style.display = 'block'
                // setScene(settings.chatGame)
            }else if(parsed.header == 'vote'){
                let command = parsed.winner
                gridLogic(command)
                barControl(command, parsed.votes)
            }else if(parsed.header == 'audioSettings'){
                let resAudio = parsed.data
                audioControl(resAudio)
            }
            console.log("received data over websocket")
            console.log(received)
        };
        ws.onclose = function() { 
            console.log("websocket closed")
        };
    
    </script>
  </body>
</html>